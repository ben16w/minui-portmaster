#!/bin/sh

TITLE="Loading"
COMMAND=""
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if [ ! -x "$SCRIPT_DIR/minui-presenter" ]; then
    echo "Error: $SCRIPT_DIR/minui-presenter not found or not executable"
    exit 1
fi

# Parse options
while [ $# -gt 0 ]; do
    case "$1" in
        --title)
            TITLE="$2"
            shift 2
            ;;
        --*) # Ignore all other -- options and their value if present
            shift
            if [ $# -gt 0 ] && [ "${1#--}" = "$1" ]; then
                shift
            fi
            ;;
        *)  # First non-option: start of the command
            COMMAND="$*"
            break
            ;;
    esac
done

if [ -z "$COMMAND" ]; then
    echo "Usage: $0 [--title title] command [args...]"
    exit 1
fi


# Start the target command in the background
sh -c "$COMMAND" &
CMD_PID=$!

killall minui-presenter >/dev/null 2>&1 || true
"$SCRIPT_DIR/minui-presenter" --disable-auto-sleep --message "$TITLE, please wait..." --timeout -1 &

wait $CMD_PID
exit_code=$?

killall minui-presenter >/dev/null 2>&1 || true
exit $exit_code